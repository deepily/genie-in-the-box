<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>

<script>

    var audioContext = null;

    function createAudioContext() {

        // Check if the AudioContext is already created
        if ( window.AudioContext || window.webkitAudioContext ) {
            audioContext = new ( window.AudioContext || window.webkitAudioContext )();
            console.log( "AudioContext created!" );
        } else {
            console.log( "AudioContext is not supported in this browser" );
        }
    }

    // Call createAudioContext() when the webpage is loaded and DOM is available
    document.addEventListener( "DOMContentLoaded", function() {
        console.log( "DOM fully loaded and parsed" );
        createAudioContext();
        updateQueueLists( "todo" );
        updateQueueLists( "run" );
        updateQueueLists( "done" );
        addClickEventToDoneList();
    } );

    function addClickEventToDoneList() {

        console.log( "Adding click event to done list..." );
        const doneList = document.getElementById( "done-list" );
        const items = doneList.getElementsByTagName( "li" );

        for ( let i = 0; i < items.length; i++ ) {
            console.log( "Adding click event to item:", items[ i ] );
            items[ i ].onclick = function() {
                foo( items[ i ].id );
            };
        }
    }

    function foo( id ) {
        console.log( id );
    }
    var socket = io();
    socket.on( "connect", function() {
        console.log( "Connected to Flask server" );
    } );

    socket.on( "time_update", function( data ) {
        document.getElementById( "clock" ).innerHTML = "[" + data.date + "]";
    } );

    // handle updates on the todo queue
    socket.on( "todo_update", function( data ) {
        document.getElementById( "todo" ).innerHTML = "Jobs TODO [" + data.value + "]";
        updateQueueLists( "todo" );
    } );

    // handle updates on the run queue
    socket.on( "run_update", function( data ) {
        document.getElementById( "run" ).innerHTML = "Jobs RUNNING [" + data.value + "]";
        updateQueueLists( "run" );
    } );

    // handle updates on the done queue
    socket.on( "done_update", function( data ) {
        document.getElementById( "done" ).innerHTML = "Jobs DONE [" + data.value + "]";
        updateQueueLists( "done" );
    } );

    function updateQueueLists( queue_name ) {
        fetch( "/get_queue/" + queue_name )
            .then( response => response.json() )
            .then( data => {
                if ( queue_name === "todo" ) {
                    document.getElementById( "todo-list" ).innerHTML = data.todo_jobs.join( "" );
                } else if ( queue_name === "run" ) {
                    document.getElementById( "run-list" ).innerHTML = data.run_jobs.join( "" );
                } else if ( queue_name === "done" ) {
                    document.getElementById( "done-list" ).innerHTML = data.done_jobs.join( "" );
                    addClickEventToDoneList();
                } else {
                    console.log( "Unknown queue name:", queue_name );
                }
            } )
            .catch( error => console.error( "Error:", error ) );
    }
    // Create a global queue for audio clips
    var audioQueue = [];
    var playing = false;
    var quiet   = false

    // Handle server notifications to play audio
    socket.on( "audio_update", async function( data ) {

        console.log( "Received audio update:", data );
        if ( quiet ) {

            console.log( `Quiet mode, not adding ${data.audioURL} to the queue` );
            // playAudioFromServer( "/static/gentle-gong.mp3" );
            url = "/static/gentle-gong.mp3"

        } else {

            if ( audioQueue.length === 0 ) {
                url = "/static/gentle-gong.mp3"
            }
            url = data.audioURL
        }
        console.log( `Adding audio url to queue: ${url}` );
        let audio = new Audio( url );
        audioQueue.push( audio );
        console.log( "Audio queue size:", audioQueue.length );

        playAll()
        // if ( !playing ) {
        //     console.log( "Calling playAll()..." );
        //     await playAll().then(function() {
        //         console.log( "Calling playAll()... Done!" );
        //     })
        // } else {
        //     console.log( "Already playing, not calling playAll()" );
        // }
    } );
    // function playAudioFromServer( audioURL ) {
    //     var audio = new Audio( audioURL );
    //     audio.play();
    // }
    async function playOne( audio ) {

        return new Promise(function(resolve, reject) {
            audio.onerror = reject;
            audio.onended = resolve;
            audio.play()
        });
    }
    async function playAll() {

        if ( playing ){
            console.log( "Already playing, exiting..." );
            return
        }
        playing = true;
        while ( audioQueue.length > 0 ) {

            let audio = audioQueue.shift();
            console.log( "calling playOne()..." )
            await playOne( audio ).then(function() {
                console.log( "calling playOne()... Done!" );
            })
        }
        playing = false;
    }

    function pushQuestion() {

        var question = document.getElementById( "question-input" ).value;
        fetch( "/push?question=" + question )
            .then( response => {
                if ( response.status === 200 ) {
                    document.getElementById( "response-status" ).textContent = "Success!";
                } else {
                    document.getElementById( "response-status" ).textContent = "Error :-( Check the console for more details.";
                    throw new Error( `HTTP error, status = ${ response.status }` );
                }
                return response.text();
            } )
            .then( ( text ) => {
                document.getElementById( "response-text" ).textContent = text;
            } )
            .catch( error => console.error( "Error:", error ) );
    }
</script>

<h1 id="clock">[00-00-0000 @ 00:00:00]</h1>
<div>
    <h2 id="todo">Jobs todo [0]</h2>
    <ol id="todo-list" reversed>

    </ol>
</div>
<div>
    <h2 id="run">Jobs running [0]</h2>
    <ol id="run-list" reversed>

    </ol>
</div>
<div>
    <h2 id="done">Jobs done [0]</h2>
    <ol id="done-list" reversed>

    </ol>
</div>
<!--<a href="#" onclick="createAudioContext(); return false;">Enable audio playback</a><br>-->
<!--Use this if autoplay is disabled. Check about:preferences 'Autoplay'-->

<div>
    <h2>Ask a question: <span id="response-status"></span></h2>
    <p id="response-text"></p>
    <input type="text" id="question-input" placeholder="Enter your question here">
    <button onclick="pushQuestion(); return false;">Submit</button>
</div>

</body>
</html>




